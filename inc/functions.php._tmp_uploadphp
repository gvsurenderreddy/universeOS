<?php
  $userid = getUser();
  $time = time();

  require_once('config.php');

  // Thumbnails: [url]www.codeschnipsel.net[/url]
  function mkthumb($img_src,     // Dateiname
                   $img_width,       // max. Größe in x-Richtung
                   $img_height,       // max. Größe in y-Richtung
                   $folder_scr,  // Ordner der normalen Bilder
                   $des_src)    // Ordner der Thumbs
  {
    // Größe und Typ ermitteln
    list($src_width, $src_height, $src_typ) = getimagesize($folder_scr."/".$img_src);

    // neue Größe bestimmen
    if($src_width >= $src_height)
    {
      $new_image_width = $img_width;
      $new_image_height = $src_height * $img_width / $src_width;
    }
    if($src_width < $src_height)
    {
      $new_image_height = $img_width;
      $new_image_width = $src_width * $img_height / $src_height;
    }

    if($src_typ == 1)     // GIF
    {
      $image = imagecreatefromgif($folder_scr."/".$img_src);
      $new_image = imagecreate($new_image_width, $new_image_height);
      imagecopyresampled($new_image, $image, 0, 0, 0, 0, $new_image_width,$new_image_height, $src_width, $src_height);
      imagegif($new_image, $des_src."/".$img_src, 100);
      imagedestroy($image);
      imagedestroy($new_image);
      return true;
    }
    elseif($src_typ == 2) // JPG
    {
      $image = imagecreatefromjpeg($folder_scr."/".$img_src);
      $new_image = imagecreatetruecolor($new_image_width, $new_image_height);
      imagecopyresampled($new_image, $image, 0, 0, 0, 0, $new_image_width,$new_image_height, $src_width, $src_height);
      imagejpeg($new_image, $des_src."/".$img_src, 100);
      imagedestroy($image);
      imagedestroy($new_image);
      return true;
    }
    elseif($src_typ == 3) // PNG
    {
      $image = imagecreatefrompng($folder_scr."/".$img_src);
      $new_image = imagecreatetruecolor($new_image_width, $new_image_height);
      imagecopyresampled($new_image, $image, 0, 0, 0, 0, $new_image_width,$new_image_height, $src_width, $src_height);
      imagepng($new_image, $des_src."/".$img_src);
      imagedestroy($image);
      imagedestroy($new_image);
      return true;
    }
    else
    {
      return false;
    }
  }
 
 function validateCapatcha($value){
     
     $sessionValue = $_SESSION['lastCaptcha'];
        //define crypt
        $value = sha1($value);
        $value = sha1("$value deine mutter lutscht riesengrosse schwaenze");
        
	if($sessionValue === sha1($value)){
            return true;
        }
	
 }
  
 function showYoutubeVideo($id, $subPath=NULL){
    ?>
	<script type="text/javascript" src="inc/swfObj/swfobject.js"></script>    
	<div id="ytapiplayer">
		You need Flash player 8+ and JavaScript enabled to view this video.
	</div>
	<script type="text/javascript">

    var params = { allowScriptAccess: "always" };
    var atts = { id: "myytplayer" };
    swfobject.embedSWF("http://www.youtube.com/v/ASPDeS3_54U?enablejsapi=1&playerapiid=ytplayer&version=3",
                       "ytapiplayer", "425", "356", "8", null, null, params, atts);

	</script>

	<?php
 }
 
 function curler($url){
 	
        //umgehen des HTTP Verbots
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, "$url");
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_USERAGENT, "universeOS");
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        $result = curl_exec($ch);
        curl_close($ch);
        
        //Result in DomDocument Laden
        $dom = new DOMDocument;
        $dom->loadXML($result);
        //Array der XML Datei auslesen.
        $xml = simplexml_import_dom($dom);
		return $xml;
 }
 
 function getRssfeed($rssfeed, $cssclass="", $encode="auto", $anzahl=10, $mode=0) {
     $data = @file($rssfeed);
     $data = implode ("", $data);
         preg_match_all("/<item.*>(.+)<\/item>/Uism", $data, $items);
     
        if($encode == "auto")
                                {
                                    preg_match("/<?xml.*encoding=\"(.+)\".*?>/Uism", $data, $encodingarray);
                                    $encoding = $encodingarray[1];
                                }
        else
            {
            $encoding = $encode;
            
            }
            
        
       $output .= "<div class=\"rssfeed_".$cssclass."\">\n";
		// Titel und Link zum Channel 
		if($mode == 1 || $mode == 3)
		{
			$data = preg_replace("/<item>(.+)<\/item>/Uism", '', $data);
			preg_match("/<title>(.+)<\/title>/Uism", $data, $channeltitle);
			preg_match("/<link>(.+)<\/link>/Uism", $data, $channellink);
			preg_match("/<url>(.+)<\/url>/Uism", $data, $channelimage);
		
			$channeltitle = preg_replace('/<!\[CDATA\[(.+)\]\]>/Uism', '$1', $channeltitle);
			$channellink = preg_replace('/<!\[CDATA\[(.+)\]\]>/Uism', '$1', $channellink);
			$channellink = preg_replace('/<!\[CDATA\[(.+)\]\]>/Uism', '$1', $channelimage);
		
			$output .= "<center class=\"grayBar\"><img src=\"./gfx/icons/rss.png\" style=\"float: left;\"><a href=\"".$channellink[1]."\" target=\"blank\" title=\"";
		        $output .= "<image src=\"".$channelimage[1]->src."\" title=\"";
			if($encode != "no")
			{$output .= htmlentities($channeltitle[1],ENT_QUOTES,$encoding);}
			else
			{$output .= $channeltitle[1];}
			$output .= "\">";
			if($encode != "no")
			{$output .= htmlentities($channeltitle[1],ENT_QUOTES,$encoding);}
			else
			{$output .= $channeltitle[1];}
			$output .= "</a></center>\n";
		}     
		     
		// Titel, Link und Beschreibung der Items
		foreach ($items[1] as $item) {
			preg_match("/<title>(.+)<\/title>/Uism", $item, $title);
			preg_match("/<link>(.+)<\/link>/Uism", $item, $link);
			preg_match("/<description>(.*)<\/description>/Uism", $item, $description);
		
			$title = preg_replace('/<!\[CDATA\[(.+)\]\]>/Uism', '$1', $title);
			$description = preg_replace('/<!\[CDATA\[(.+)\]\]>/Uism', '$1', $description);
			$link = preg_replace('/<!\[CDATA\[(.+)\]\]>/Uism', '$1', $link);
		
			$output .= "<div class=\"rssTitle\">\n";
			$output .= "<a href=\"#\" onclick=\"openURL('".$link[1]."', '$channeltitle'); return false\" target=\"blank\" title=\"";
			if($encode != "no")
			{$output .= htmlentities($title[1],ENT_QUOTES,$encoding);}
			else
			{$output .= $title[1];}
			$output .= "\">";
			if($encode != "no")
			{$output .= htmlentities($title[1],ENT_QUOTES,$encoding)."</a>\n";}
			else
			{$output .= $title[1]."</a>\n";}
			$output .= "</div>\n";
			if($mode == 2 || $mode == 3 && ($description[1]!="" && $description[1]!=" "))
			{
				$output .= "<div class=\"rssDescription\">\n";
				if($encode != "no")
				{$output .= htmlentities($description[1],ENT_QUOTES,$encoding)."\n";}
				else
				{$output .= $description[1];}
				$output .= "</div><hr>\n";
			}
			if ($anzahl-- <= 1) break;
		}
		$output .= "</div>\n\n";
		return $output;

 }
 function showRssFeed($url){
        $feed_url = "$url";

   // INITIATE CURL. 
   $curl = curl_init();

   // CURL SETTINGS. 
   curl_setopt($curl, CURLOPT_URL,"$feed_url"); 
   curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); 
   curl_setopt($curl, CURLOPT_CONNECTTIMEOUT, 0); 

   // GRAB THE XML FILE. 
   $xmlTwitter = curl_exec($curl); 
   curl_close($curl);

   // SET UP XML OBJECT.
   // Use either one of these, depending on revision of PHP.
   // Comment-out the line you are not using.
   //$xml = new SimpleXMLElement($xmlTwitter);
   $xml = simplexml_load_string($xmlTwitter); 

   // How many items to display 
   $count = 10; 

   // How many characters from each item 
   // 0 (zero) will show them all. 
   $char = 0; 
   
   
   //show channel image
   echo '<img src="'.($xml->channel->image->url).'" class="newsTitleImage">';
   foreach ($xml->channel->item as $item) { 
   if($char == 0){ 
   $newstring = $item->description; 
   } 
   else{ 
   $newstring = substr($item->description, 0, $char); 
   } 
   if($count > 0){
   //in case they have non-closed italics or bold, etc ... 
   echo"</i></b></u></a>\n"; 
   echo" 
   <div style='font-family:arial; font-size: 12pt;' class='newsArticleBox'>
   <h3 style='line-height: 30px;'>{$item->title}</h3>
   $newstring <br><br><a href='#' onclick=\"openURL('{$item->guid}', '{".mysql_real_escape_string($item->title)."}'); return false\" target='_blank' class='btn btn-info'>read all</a>
   <br /><br /> 
   </div> 
   ";  
   } 
   $count--; 
   } 
 }    
 
 
    //shows the settins button for folders, elements, files, playlists and posts.
    function showItemSettings($type, $itemId){
        if($type == "feed"){
            $feedCheck = mysql_query("SELECT author, privacy FROM feed WHERE id='$itemId'");
            $feedData = mysql_fetch_array($feedCheck);
            if(authorize($feedData[privacy], "edit", $feedData[author])){
                $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=feed&itemId=$itemId')\">Privacy</a></li>";
                $delete = "<li><a href=\"doit.php?action=deleteItem&type=feed&itemId=$itemId\" target=\"submitter\">Delete</a></li>";
            }
        }elseif($type == "comment"){
            $commentCheck = mysql_query("SELECT author, type, typeid, privacy FROM comments WHERE id='$itemId'");
            $commentData = mysql_fetch_array($commentCheck);
            
            //allow profile owner to delete comments that other users made in his profile
            if($commentData[type] == "profile" && $commentData[typeid] == $_SESSION[userid]){
            $delete = "<li><a href=\"doit.php?action=deleteItem&type=comment&itemId=$itemId\" target=\"submitter\">Delete</a></li>";    
            }
            if(authorize($commentData[privacy], "edit", $commentData[author])){
                $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=comment&itemId=$itemId')\">Privacy</a></li>";
                $delete = "<li><a href=\"doit.php?action=deleteItem&type=comment&itemId=$itemId\" target=\"submitter\">Delete</a></li>";    
            }
        }elseif($type == "folder"){
            $checkFolderSql = mysql_query("SELECT privacy, creator FROM folders WHERE id='$itemId'");
            $checkFolderData = mysql_fetch_array($checkFolderSql);
            if(authorize($checkFolderData[privacy], "edit", $checkFolderData[creator])){
                $edit = "<li><a href=\"#\" onclick=\"popper('doit.php?action=editItem&type=folder&itemId=$itemId')\" target=\"submitter\">Edit</a></li>";
                $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=folder&itemId=$itemId')\">Privacy</a></li>";
                $delete = "<li><a href=\"doit.php?action=deleteItem&type=folder&itemId=$itemId\" target=\"submitter\">Delete</a></li>";    
            }
	        if(proofLogin()){
	          	$fav = "<li><a href=\"doit.php?action=addFav&type=folder&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
	        }
			if(hasRight("protectFileSystemItems")){
				$protect = "<li><a href=\"javascript: popper('doit.php?action=protectFileSystemItems&type=folder&itemId=$itemId')\">Protect</a></li>";
			}
        }elseif($type == "element"){
            $checkElementSql = mysql_query("SELECT privacy, author FROM elements WHERE id='$itemId'");
            $checkElementData = mysql_fetch_array($checkElementSql);
            if(authorize($checkElementData[privacy], "edit", $checkElementData[author])){
                $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=element&itemId=$itemId')\">Privacy</a></li>";
                $edit = "<li><a href=\"#\" onclick=\"popper('doit.php?action=editItem&type=element&itemId=$itemId')\" target=\"submitter\">Edit</a></li>";
                $delete = "<li><a href=\"#\" onclick=\"popper('doit.php?action=deleteItem&type=element&itemId=$itemId')\" target=\"submitter\">Delete</a></li>";
            }
	        if(proofLogin()){
	          	$fav = "<li><a href=\"doit.php?action=addFav&type=element&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
	        }
			if(hasRight("protectFileSystemItems")){
				$protect = "<li><a href=\"javascript: popper('doit.php?action=protectFileSystemItems&type=element&itemId=$itemId')\">Protect</a></li>";
			}
        }elseif($type == "file"){
            $checkFileSql = mysql_query("SELECT privacy, owner FROM files WHERE id='$itemId'");
            $checkFileData = mysql_fetch_array($checkFileSql);
            if(authorize($checkFileData[privacy], "edit", $checkFileData[owner])){
                $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=file&itemId=$itemId')\">Privacy</a></li>";
                $delete = "<li><a href=\"doit.php?action=deleteItem&type=file&itemId=$itemId\" target=\"submitter\">Delete</a></li>";  
                
            }
			if(proofLogin()){
            $fav = "<li><a href=\"doit.php?action=addFav&type=file&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
			}
            $report = "<li><a href=\"javascript: popper('doit.php?action=reportFile&fileId=$itemId')\">Report</a></li>";
			if(hasRight("protectFileSystemItems")){
				$protect = "<li><a href=\"javascript: popper('doit.php?action=protectFileSystemItems&type=file&itemId=$itemId')\">Protect</a></li>";
			}
        }elseif($type == "link"){
            $checkLinkSql = mysql_query("SELECT privacy, author FROM links WHERE id='$itemId'");
            $checkLinkData = mysql_fetch_array($checkLinkSql);
            if(authorize($checkLinkData[privacy], "edit", $checkLinkData[author])){
                $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=link&itemId=$itemId')\">Privacy</a></li>";
				$edit = "<li><a href=\"#\" onclick=\"popper('doit.php?action=editItem&type=link&itemId=$itemId')\" target=\"submitter\">Edit</a></li>";
                
                $delete = "<li><a href=\"doit.php?action=deleteLink&linkId=$itemId\" target=\"submitter\">Delete</a></li>";
            }
			if(proofLogin()){
                            $fav = "<li><a href=\"doit.php?action=addFav&type=link&item=$itemId\" target=\"submitter\">Add to Fav</a></li>"; 
			} 
                            $report = "<li><a href=\"javascript: popper('doit.php?action=reportFile&fileId=$itemId')\">Report</a></li>";
			if(hasRight("protectFileSystemItems")){
                            $protect = "<li><a href=\"javascript: popper('doit.php?action=protectFileSystemItems&type=link&itemId=$itemId')\">Protect</a></li>";
			}
        }else if($type == "internLink"){
            $checkInternLinkData = mysql_fetch_array(mysql_query("SELECT * FROM internLinks WHERE id='$itemId'"));
            
                if($checkInternLinkData[type] == "folder"){
                    
                    $shortCutItemData = mysql_fetch_array(mysql_query("SELECT name, privacy, creator FROM folders WHERE id='$checkInternLinkData[typeId]'"));
                    
                    $user = $shortCutItemData[creator];
                    
                }else if($checkInternLinkData[type] == "element"){
                    
                    $shortCutItemData = mysql_fetch_array(mysql_query("SELECT title, privacy, creator FROM elements WHERE id='$checkInternLinkData[typeId]'"));
                    $user = $shortCutItemData[creator];
                }else if($checkInternLinkData[type] == "file"){

                    $shortCutItemData = mysql_fetch_array(mysql_query("SELECT title, privacy, type, owner FROM files WHERE id='$checkInternLinkData[typeId]'"));
                    $user = $shortCutItemData[owner];
  
                }else if($checkInternLinkData[type] == "link"){

                    $shortCutItemData = mysql_fetch_array(mysql_query("SELECT title, link, privacy, type, author FROM links WHERE id='$checkInternLinkData[typeId]'"));
                    $user = $shortCutItemData[author];
                  
                }
                
                if(authorize($shortCutItemData[privacy], "edit", $user)){
                    
                    $delete = "<li><a href=\"doit.php?action=deleteItem&type=internLink&itemId=$itemId\" target=\"submitter\">Delete</a></li>";  
                    
                }
                
            
            
        }
        if(!empty($privacy) || !empty($fav) || !empty($delete) || !empty($edit) || !empty($report)){
        $return = "
        <a href=\"#\" onclick=\"$(this).next('.itemSettingsWindow').slideToggle(); $('.itemSettingsWindow').this(this).hide();\" class=\"btn btn-mini\"><i class=\"icon-cog\"></i></a>
        <div class=\"itemSettingsWindow\">
            <ul>
                $privacy
                $fav
                $delete
                $edit
                $report
                $protect
            </ul>
        </div>
        ";
        
        return $return;
    }}
  function showRightClickMenu($type, $itemId, $title, $info1=NULL){
      
      if($type == "folder"){
          //info1 is the creator of the folder
          //it is used to proof if privacy settings should be shown
          $checkFolderSql = mysql_query("SELECT privacy, creator FROM folders WHERE id='$itemId'");
          $checkFolderData = mysql_fetch_array($checkFolderSql);
          
          $open = "<li><a href=\"javascript: openFolder('$itemId')\">Open</a></li>";
          if(authorize($checkFolderData[privacy], "edit", $checkFolderData[creator])){
              $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=folder&itemId=$itemId')\">Privacy</a></li>";
          }
          if(proofLogin()){
          	$fav = "<li><a href=\"doit.php?action=addFav&type=folder&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
          }
      }
      
      if($type == "element"){
         $checkElementSql = mysql_query("SELECT privacy, author FROM elements WHERE id='$itemId'");
         $checkElementData = mysql_fetch_array($checkElementSql);
		 
          	$open = "<li><a href=\"#\" onclick=\"openElement('$itemId', '$title'); return false;\">Open</a></li>";
          
         if(authorize($checkElementData[privacy], "edit", $checkElementData[author])){
            $privacy = "<li><a href=\"javascript: popper('doit.php?action=changePrivacy&type=element&itemId=$itemId')\">Privacy</a></li>";  
         }
         $fav = "<li><a href=\"doit.php?action=addFav&type=element&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
      }
      if($type == "file"){
          $open = "<li><a href=\"#\" onclick=\"openFile('$info1', '$itemId', '$title');\">Open</a>";
          $fav = "<li><a href=\"doit.php?action=addFav&type=file&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
          $playList = "<li><a href=\"javascript: popper('doit.php?action=addFileToPlaylist&file=$itemId')\">Add to Playlist</a></li>";
          $download = "<li><a href=\"doit.php?action=download&fileId=$itemId\">download</a></li>";
      }
        if($type == "image"){
          $checkFileSql = mysql_query("SELECT privacy, owner FROM files WHERE id='$itemId'");
          $checkFileData = mysql_fetch_array($checkFileSql);
	          $open = "<li><a href=\"#\" onclick=\"openFile('image', '$itemId', '$title');\">Open</a>";
	          $background = "<li><a href=\"doit.php?action=changeBackgroundImage&type=file&id=$itemId\" target=\"submitter\">set as background</a></li>";
	          $fav = "<li><a href=\"doit.php?action=addFav&type=file&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
	          $download = "<li><a href=\"doit.php?action=download&fileId=$itemId\">download</a></li>";
	      if(authorize($checkFileData[privacy], "edit", $checkFileData[owner])){
          	  $delete = "<li><a href=\"doit.php?action=deleteItem&type=file&itemId=$itemId\" target=\"submitter\">Delete</a></li>";
          }
        }
      if($type == "link"){
          //info1 is used as filetype, because it is needed in the JS-openfile() function
          $open = "<li><a href=\"#\" onclick=\"openFile('$info1', '$itemId', '$title');\">Open</a></li>";
          $fav = "<li><a href=\"doit.php?action=addFav&type=link&item=$itemId\" target=\"submitter\">Add to Fav</a></li>";
          $playList = "<li><a href=\"javascript: popper('doit.php?action=addFileToPlaylist&link=$itemId')\">Add to Playlist</a></li>";
          
      }
	  
	  $output = "<span id=\"rightClick$type$itemId\" class=\"rightclick\" style=\"display: none;\">";
	  	$output .= "<ul>";
		
        	$output .= $open;
            $output .= $fav;
            $output .= $playList;
            $output .= $privacy;
            $output .= $download;
            $output .= $background;
            $output .= $delete;
	  	$output .= "</ul>";
	  $output .= "</span>";
		
		echo $output;
  }
  
  function createUser($username, $password){
    $user = save($username);
    $sql = mysql_query("SELECT username FROM user WHERE username='$user'");
    $data = mysql_fetch_array($sql);
    
    if(empty($data[username]) && validateCapatcha("$_POST[captcha]")){
          
        $password = md5($password);
        $time = time();
        mysql_query("INSERT INTO `user` (`password`, `username`, `email`, `regdate`, `lastactivity`) VALUES ('$password', '$_POST[username]', '', '$time', '$time')");

        $userid = mysql_insert_id();
        
        
        //create user folder(name=userid) in folder userFiles
        $userFolder = createFolder("2", $userid, $userid, "h");
        
        //create folder for userpics in user folder
        $pictureFolder = createFolder($userFolder, "userPictures", $userid, "h");
        
        //create thumb folders || NOT LISTED IN DB!
        $path3 = ".//upload//userFiles//$userid//userPictures//thumb";
        $path4 = ".//upload//userFiles//$userid//userPictures//thumb//25";
        $path5 = ".//upload//userFiles//$userid//userPictures//thumb//40";
        $path6 = ".//upload//userFiles//$userid//userPictures//thumb//300";
        mkdir($path3);  //Creates Thumbnail Folder
        mkdir($path4); //Creates Thumbnail Folder
        mkdir($path5); //Creates Thumbnail Folder
        mkdir($path6); //Creates Thumbnail Folder
        
        
        //create Element "myFiles" in userFolder
        $myFiles = createElement($userFolder, "myFiles", "myFiles", $userid, "h");
        
        //create Element "user pictures" to collect profile pictures
        $pictureElement = createElement($pictureFolder, "profile pictures", "image", $userid, "p");


        mysql_query("UPDATE user SET homefolder='$userFolder', myFiles='$myFiles', profilepictureelement='$pictureElement' WHERE userid='$userid'");

        echo"1";
    }
      
  }
  
  function deleteUser($userid, $reason){
      $authorization = true;
      if($authorization){
          
          //delete all files
          $fileSQL = mysql_query("SELECT id FROM files WHERE owner='$userid'");
          while($fileData = mysql_fetch_array($fileSQL)){
              deleteFile($fileData[id]);
              
          }
          
          //delete all links
          $linkSQL = mysql_query("SELECT id FROM links WHERE author='$userid'");
          while($linkData = mysql_fetch_array($linkSQL)){
              deleteLink($linkData[userid]);
          }
          
          
          //elements
          $elementSQL = mysql_query("SELECT id FROM elements WHERE author='$userid'");
          while($elementData = mysql_fetch_array($elementSQL)){
              deleteElement($elementData[id]);
          }
          
          
          //folders
          $folderSQL = mysql_query("SELECT id FROM folders creator='$userid'");
          while($folderData = mysql_fetch_array($folderSQL)){
              deleteFolder($folderData[id]);
          }
          
          //comments
          
          
          //buddy
          mysql_query("DELETE FROM buddylist WHERE buddy='$userid' OR owner='$userid'");
          
          //delete user
          mysql_query("DELETE FROM user WHERE userid='$userid'");
         
          
          //log userid, username, reason
          
      }
  }
  
  function proofLogin(){
      if(isset($_SESSION[userid])){
          return true;
      }else{
          return false;
      }
  }
  
  function getUser(){
  	
  	if(isset($_SESSION['userid'])){
  		return $_SESSION['userid'];
  	}else{
  		return false;
  	}
  }
  
  function hasRight($type){
	  //checks if user has right to ...
	  //gets information from $global_userGroupData
	  //whis is defined in config.php
	  
	  $userData = mysql_fetch_array(mysql_query("SELECT `usergroup` FROM `user` WHERE `userid`='$_SESSION[userid]'"));
	  $userGroupData = mysql_fetch_array(mysql_query("SELECT * FROM `userGroups` WHERE `id`='$userData[usergroup]'"));
	  
	  if($userGroupData["$type"] == "1"){
	  	return true;
	  }else{
	  	return false;
	  }
  	
  }
  
  function hasLies($type){
	  return $global_userGroupData["protectFileSystemItems"];
  	
  }
  
  function checkMobileAuthentification($username, $hash){
      
        $username = $username;
        $hash = $hash;
        
        $loginSQL = mysql_query("SELECT userid, username, password FROM user WHERE username='$username'");
        $loginData = mysql_fetch_array($loginSQL);
        $dbPassword = $loginData[password];
        $dbPassword = hash('sha1', $dbPassword);
        if($hash == $dbPassword){
            return true;
        }
  }
  
  function usernameToUserid($username){
        $loginSQL = mysql_query("SELECT userid, username FROM user WHERE username='$username'");
        $loginData = mysql_fetch_array($loginSQL);
        return $loginData[userid];
  }
  
  function useridToUsername($userid){
        $loginSQL = mysql_query("SELECT userid, username FROM user WHERE userid='$userid'");
        $loginData = mysql_fetch_array($loginSQL);
        return $loginData[username];
  }
  
  function getUserData($userid=NULL){
  	if(empty($userid)){
  		$userid = getUser();
  	}
	
	$userData = mysql_fetch_array(mysql_query("SELECT * FROM `user` WHERE userid='$userid'"));
	return $userData;
  }

  function showUserPicture($userid, $size, $subpath = NULL, $small = NULL /*defines if functions returns or echos and if script with bordercolor is loaded*/){
    $picSQL = mysql_query("SELECT userid, lastactivity, userPicture, priv_profilePicture FROM user WHERE userid='".mysql_real_escape_string($userid)."'");
    $picData = mysql_fetch_array($picSQL);
    $time = time();
    
    $difference = ($time - $picData[lastactivity]);
     if($difference < 90){
        $color = "#B1FFAD";
     }else if($difference > 90 && $difference < 600) {
        $color = "#F9FFD3";
     } elseif($difference > 600) {
        $color = "#FD5E48";
     }
     
    if(isset($subpath)) {
        if($subpath !== "total"){
        $path = "./../.";
        $subPath = 1;
        }
        
    }else{
        $subPath = NULL;
    }
      
        
        $doubleSize = $size*2;
        //there are three different thumb sizes which are created when
        //the userpicture is uploaded, depending on the requested size
        //a different thumb needs to be choosen to minimize traffic
        if($size < "25"){
            $folderpath = "25";

        } else if($size < "40"){
            $folderpath = "40";

        } else if($size < "300"){
            $folderpath = "300";

        }
		$size.="px";
    
    if(empty($picData[userPicture])){
        
        
    	$class = "standardUser";
    
    }else{
        
		$class = "";
		
        if($subpath !== "total"){
            
            $src = "$path./upload/userFiles/$userid/userPictures/thumb/$folderpath/".$picData['userPicture']."";
			if(empty($class)){
				
            	$style = "background-image: url('$src'); background-size:  150px;";
			}
        }else{
            $src = "./upload/userFiles/$userid/userPictures/thumb/$folderpath/".$picData['userPicture']."";
			if(empty($class)){
            	$style = "background-image: url('$src');";
			}
        }
        
    }
       

        if($subpath !== "total"){
            
            $return="<div class=\"userPicture userPicture_$userid $class\" onload=\"updatePictureStatus('$userid', '$color');\" onclick=\"showProfile('$userid');\" style=\"width: $size; height: $size; border-color: $color; $style\"></div>";
        }else{
            $return="<div class=\"userPicture userPicture_$userid $class\" onload=\"updatePictureStatus('$userid', '$color');\" onclick=\"showProfile('$userid;');\" style=\"width: $size; height: $size; $style border-color: $color; $style\"></div>";
        }
      
      
      
      
        if($small){
        	if(empty($class)){
        		$style = " background-image: url(\\'$src\\');";
			}
            $return="<div class=\"userPicture userPicture_$userid $class\" onload=\"updatePictureStatus(\'jjj$userid\', \\'$color\\');\" onclick=\"showProfile(\\'$userid\\');\" style=\"$style width: $size; height: $size; border-color: $color;\"></div>";

            return $return;
        }else{
//            $return .= "<script>";
//            $return .= "$('.userPicture_$userid').css('border-color', '$color');";
//            $return .= "</script>";
            echo $return;
        }
      }function updateActivity($userid){
      $time = time();
      mysql_query("UPDATE user SET lastactivity='$time' WHERE userid='$userid'");
  }
  //shows online status
     
  function userSignature($userid, $timestamp, $subpath = NULL, $reverse=NULL){
    $feedUserSql = mysql_query("SELECT userid, username, userPicture FROM user WHERE userid='$userid'");
    $feedUserData = mysql_fetch_array($feedUserSql);
    if(isset($subpath)){
        $path = "./../.";
        $subPath = 1;
    }else{
        $subPath = NULL;
    }
      ?>
    <div class="signature" style="background: #EDEDED; border-bottom: 1px solid #c9c9c9;">
    <table width="100%">
        <tr width="100%">
            <?php
            if(empty($reverse)){ ?>
            <td>
                <table>
                    <tr>
                        <td style="font-size: 10pt;">&nbsp;<a href="#" onclick="showProfile(<?=$feedUserData[userid];?>);"><?=$feedUserData[username];?></a></td>
                    </tr>             
                    <tr>
                        <td style="font-size: 08pt;">&nbsp;<i><?=universeTime($timestamp);?></i></td>
                    </tr>
                </table>
            </td>
            <td align="right"><span class="pictureInSignature"><?=showUserPicture($feedUserData[userid], "30", $subpath);?></span></td>
            <?}else{?>
            <td><?=showUserPicture($feedUserData[userid], "30", $subpath);?></td>
            <td>
                <table>
                    <tr>
                        <td style="font-size: 10pt;">&nbsp;<?=$feedUserData[username];?></td>
                    </tr>             
                    <tr>
                        <td style="font-size: 08pt;">&nbsp;<i><?=universeTime($timestamp);?></i></td>
                    </tr>
                </table>
            </td>
            <?}?>
        </tr>
    </table>
    </div>
      <?php
  }


  function getUserFavs($userid=NULL){
  	if(empty($userid)){
  		$userid=$_SESSION[userid];
  	}
  	$favSQL = mysql_query("SELECT * FROM fav WHERE user='$userid'");
		while($favData = mysql_fetch_array($favSQL)){
			$return[] = $favData;
		}
		
		return $return;
  }

	function getUserFavOutput($user){
		if(empty($user)){
			$user = $_SESSION['userid'];
		}
		
		
	}

   //gets all unseen messages for receiver=user
   function getLastMessages($user=NULL){
   	if($user == NULL){
   		$user = $_SESSION['userid'];
   	}else{
   		$user = save($user);
   	}
   	
	$newMessagesSql = mysql_query("SELECT * FROM  `messages` WHERE  receiver='$user' OR sender='$user' ORDER BY timestamp DESC LIMIT 0, 5");
	while($newMessagesData = mysql_fetch_array($newMessagesSql)){
		$session .= "newMessage $newMessagesData[id]";
		
		
		//each sender is only listed once
		if(!in_array($newMessagesData['sender'], $listedUsers)){
	    $text = substr($newMessagesData[text], 0, 100);

		//define everything that is important	    
		$return['messageId'] = $newMessagesData['id'];
		$return['sender'] = $newMessagesData['sender'];
		$return['receiver'] = $newMessagesData['receiver'];
		$return['timestamp'] = $newMessagesData['timestamp'];
		$return['text'] = $newMessagesData['text'];
		
		$return['seen'] = $newMessagesData['seen'];
		$return['read'] = $newMessagesData['read'];
		$return['senderUsername'] = useridToUsername($newMessagesData['sender']);
		
		//add sender too users array
		$listedUsers[] = $newMessagesData['sender'];
		
		//add all return data to returner array
		$returner[] = $return;
			
		}
	}
	
	return $returner;
	
   }
   
   function getMessageData($messageId){
   	$newMessagesSql = mysql_query("SELECT * FROM  `messages` WHERE  id='".mysql_real_escape_string($messageId)."'");
	return mysql_fetch_array($newMessagesSql);
   }
   
//fav
//fav
//fav

  function addFav($type, $typeid, $userid){
      $type = $_GET[type];
      $check = mysql_query("SELECT type,item FROM fav WHERE type='$_GET[type]' && item='$_GET[item]'");
      $checkData = mysql_fetch_array($check);
      if(isset($checkData[type])){
        echo"allready your favourite";
      } else {
        $time = time();
        mysql_query("INSERT INTO fav (`type` ,`item` ,`user` ,`timestamp`) VALUES('$_GET[type]', '$_GET[item]', '$_SESSION[userid]', '$time');"); 
        echo"worked :)";
    }
  }

    
    function showFav($user=NULL){ 
                        if($user == NULL){
                        	$user = getUser();
                       	}
                        
                    	$userFavs = getUserFavs($user);
						$i = 0;
					foreach($userFavs AS $filefdata){
							$item = $filefdata['item'];
                            $type = $filefdata['type'];
                            
                            //derive the table and the image from fav-type
                            if($type == "folder"){
                                $typeTable = "folders";
                                $img = "filesystem/folder.png";
                                $link = "openFolder($item); return false;";
                            }else if($type == "element"){
                                $typeTable = "elements";
                                $img = "filesystem/element.png";
                                $link = "openElement($item); return false;";
                            }else if($type == "file"){
                                $typeTable = "files";
                                $fileType = fileIdToFileType($item);
                                $img = "fileIcons/".getFileIcon($fileType, $size=NULL);
                                
                            }else if($type == "link"){
                                $typeTable = "links";
                                $fileType = linkIdToFileType($item);
                                $img = "fileIcons/".getFileIcon($fileType, $size=NULL);
                                
                            }
                            $favFolderSql = mysql_query("SELECT * FROM $typeTable WHERE id='$item'");
                            $favFolderData = mysql_fetch_array($favFolderSql);
                            if($filefdata['type'] == "folder"){
                            $filefdata['title'] = $filefdata['name'];
                            }
                            if($i%2 == 0){
                                $color="FFFFFF";
                            }else {
                                $color="e5f2ff";
                            }
                            $i++;
							
							$output .= "<tr class=\"strippedRow\" onmouseup=\"showMenu('folder$filefdata[id]')\">";
								$output .= "<td onmouseup=\"showMenu(".$favFolderData['id'].")\" width=\"35\">&nbsp;<img src=\"./gfx/icons/$img\" height=\"20\"></td>";
								$output .= "<td onmouseup=\"showMenu(".$favFolderData['id'].")\"><a href=\"#\" onclick=\"$link\">".$favFolderData['name'].""."".$favFolderData['title']."/</a></td>";
                                    if($user == getUser()){
                                    	
                                    $output .= "<td align=\"right\"><a class=\"btn btn-mini\" onclick=\"removeFav('$type', '$item')\"><i class=\"icon-remove\"></i></a></td>";
                                    
                                    }

                                $output .= "</tr>";
                         }
						   if($i == 0){
						   		$output .="<tr>";
							   		$output .="<td colspan=\"2\">";
									$output .="You don't have any favourites so far. Add folders, elements, files, playlists or other items to your favourites and they will appear here.";
							   		$output .="</td>";
						   		$output .="</tr>";
						   }
						   
						   return $output;
        
        
    }

	function removeFav($type, $item){
		
			if(mysql_query("DELETE FROM fav WHERE type='".mysql_real_escape_string($type)."' AND user='$_SESSION[userid]' AND item='".mysql_real_escape_string($item)."'")){
				return true;
			}
		
	}
    
//comments
//comments
//comments	
	
  function addComment($type, $itemid, $author, $message){
     $time = time();
     mysql_query("INSERT INTO comments (`type`,`typeid`,`author`,`timestamp`,`text`, `privacy`) VALUES('$type','$itemid','$author','$time','$message', 'p');");
     $commentId = mysql_insert_id();
     if($type == "feed"){
         //fügt Benachrichtigung für den Author des Feeds hinzu, falls ein anderer User einen Kommentar erstellt
         $feedSql = mysql_query("SELECT owner FROM userfeeds WHERE feedid='$itemid'");
         $feedData = mysql_fetch_array($feedSql);
         if($_SESSION[userid] !== "$feedData[owner]"){
         mysql_query("INSERT INTO personalEvents (`owner`,`user`,`event`,`info`,`eventId`,`timestamp`) VALUES('$feedData[owner]','$_SESSION[userid]', 'comment','feed','$itemid','$time');");
         }
	   }
	   else if($type == "profile"){
	        mysql_query("INSERT INTO personalEvents (`owner`,`user`,`event`,`info`,`eventId`,`timestamp`) VALUES('$itemid','$_SESSION[userid]', 'comment','profile','$itemid','$time');");
	   }
   }
   
   function deleteComments($type, $itemid){
       if(mysql_query("DELETE FROM `comments` WHERE `type`='$type' AND `typeid`='$itemid'")){
           return true;
       }
   }
   
function countComment($type, $itemid){
    $result = mysql_query("SELECT * FROM comments WHERE type='$type' && typeid='$itemid' ORDER BY timestamp");
    $num_rows = mysql_num_rows($result);
    return $num_rows;
}

function showComments($type, $itemid) {
    if(proofLogin()){?>
    <div id="<?=$type;?>Comment_<?=$itemid;?>">    
     <script>
     $('#addComment').submit(function() {
     return false;
     });
    </script>
    <div class="shadow commentRow">
      <center>
      <form action="showComment.php" method="post" id="addComment" target="submitter">
          <table>
              <tr>
                  <td><?=showUserPicture($_SESSION[userid], "25");?></td>
                  <td><input type="text" name="comment" placeholder="write commenta.." class="commentField" style="width: 100%; height:17px;"></td>
                  <td><input type="submit" value="send" class="btn btn-small" name="submitComment" style="margin-left:13px;"></td>
              </tr>
                <input type="hidden" name="itemid" value="<?=$itemid;?>">
                <input type="hidden" name="user" value="<?=$_SESSION[userid];?>">
                <input type="hidden" name="type" value="<?=$type;?>">
          </table>
      </form>
      </center>
    </div>

    <?php
    }
    if($type == "comment"){
        $comment_sql = mysql_query("SELECT * FROM comments WHERE type='$type' && typeid='$itemid' ORDER BY timestamp DESC");
        while($comment_data = mysql_fetch_array($comment_sql)) {?>
            <div class="shadow subComment commentBox<?=$comment_data[id];?>" id="<?=$type;?>Comment" style="background-color: #FFF;">
            <?=userSignature($comment_data[author], $comment_data[timestamp]);?>
            <br><?=$comment_data[text];?><br><br>

            <div style="padding: 15px; "><div><span style="float:left;"><?=showScore(comment, $comment_data[id]);?></span><span style="float:left;"><?=showItemSettings('comment', "$comment_data[id]");?></span></div></div>
            </div>
            <?php
            }

    }else{
    $comment_sql = mysql_query("SELECT * FROM comments WHERE type='$type' && typeid='$itemid' ORDER BY timestamp DESC");
    while($comment_data = mysql_fetch_array($comment_sql)) { 
    $jsId = $comment_data[id];
    ?>
    <div class="shadow subComment commentBox<?=